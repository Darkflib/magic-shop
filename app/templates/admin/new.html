{% extends "admin/base.html" %}

{% block title %}Create Product - Admin{% endblock %}

{% block content %}
<div class="admin-content">
    <div class="admin-header-row">
        <h2>Create New Product</h2>
        <a href="/admin" class="btn btn-secondary">Back to List</a>
    </div>

    <div class="admin-form-container">
        <div class="form-card">
            <h3>Product Creation</h3>
            <p class="form-help">
                Enter a one-line description of your magical item.
                The AI will generate a full description, image, and all product details.
                This process may take 10-30 seconds.
            </p>

            <form hx-post="/admin/create" hx-target="#result" hx-swap="innerHTML" hx-on::after-request="handleResponse(event)">
                <div class="form-group">
                    <label for="description">Product Description (one line)</label>
                    <input
                        type="text"
                        id="description"
                        name="description"
                        class="form-control"
                        placeholder="e.g., A sword that glows in the presence of orcs"
                        required
                        maxlength="200"
                    >
                    <small class="form-text">Brief description of the magical item you want to create</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        Create Product
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        Clear
                    </button>
                </div>
            </form>

            <div id="result" class="result-container">
                <!-- Results will be inserted here by HTMX -->
            </div>
        </div>

        <div class="info-card">
            <h4>How it works</h4>
            <ol class="info-list">
                <li>AI generates a detailed magical description</li>
                <li>Creates a unique image for your item</li>
                <li>Extracts metadata (name, category, rarity, price)</li>
                <li>Saves everything to the database</li>
            </ol>
            <p class="info-note">
                The process is fully automated and may take up to 30 seconds.
                Please be patient while the magic happens!
            </p>
        </div>
    </div>
</div>

<script>
    // Add loading indicator on form submission
    document.addEventListener('htmx:beforeRequest', function(event) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Generating magical description and image...</p>
                <p class="loading-subtext">This may take 10-30 seconds. Please wait.</p>
            </div>
        `;
    });

    // Handle response (both success and error)
    function handleResponse(event) {
        const xhr = event.detail.xhr;
        const resultDiv = document.getElementById('result');

        // HTMX automatically swaps content for 200-299 status codes
        // For error status codes (400, 500), we need to manually swap
        if (xhr.status >= 400) {
            resultDiv.innerHTML = xhr.responseText;
        }

        // Clear form on successful creation
        if (xhr.status === 200 && xhr.responseText.includes('success')) {
            const form = event.target.closest('form');
            if (form) {
                form.reset();
            }
        }
    }
</script>
{% endblock %}
